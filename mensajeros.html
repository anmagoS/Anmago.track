<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Mensajeros</title>
    <style>
        /* RESET MINIMAL */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 10px; }
        
        /* LOGIN - Solo aparece si no hay sesi√≥n */
        .login-box {
            max-width: 300px; margin: 50px auto; padding: 20px;
            background: white; border-radius: 10px; text-align: center;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ddd; border-radius: 5px;
            font-size: 16px;
        }
        .login-btn {
            width: 100%; padding: 12px; background: #007bff;
            color: white; border: none; border-radius: 5px;
            font-size: 16px; margin-top: 10px;
        }
        
        /* HEADER DASHBOARD */
        .header {
            background: #007bff; color: white; padding: 15px;
            border-radius: 10px; margin-bottom: 15px;
        }
        .header h3 { font-size: 18px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        
        /* CONTADORES */
        .contadores {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; margin-bottom: 15px;
        }
        .contador {
            background: white; padding: 15px;
            border-radius: 8px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .contador .numero {
            font-size: 24px; font-weight: bold;
            color: #007bff;
        }
        
        /* LISTA PAQUETES */
        .lista-paquetes { margin-bottom: 20px; }
        .paquete {
            background: white; padding: 15px;
            border-radius: 8px; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .paquete h4 {
            color: #333; margin-bottom: 5px;
            font-size: 16px;
        }
        .paquete p {
            color: #666; font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* BOTONES */
        .botones {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .btn {
            padding: 12px; border: none; border-radius: 5px;
            font-size: 14px; font-weight: bold;
        }
        .btn-entregar { background: #28a745; color: white; }
        .btn-novedad { background: #ffc107; color: black; }
        
        /* MODAL NOVEDAD */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white; margin: 20px; padding: 20px;
            border-radius: 10px; max-width: 400px;
            position: relative; top: 50%; transform: translateY(-50%);
        }
        .select-motivo {
            width: 100%; padding: 10px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 5px;
        }
        .textarea-obs {
            width: 100%; padding: 10px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 5px;
            min-height: 80px;
        }
        
        /* LOADING */
        .loading {
            text-align: center; padding: 20px;
            color: #666;
        }
        
        /* TAMA√ëO M√çNIMO: 5KB total (compressed) */
    </style>
</head>
<body>

<!-- LOGIN SECTION -->
<div id="loginSection" class="login-box">
    <h2>üöö Mensajeros</h2>
    <input type="tel" id="celular" class="login-input" 
           placeholder="Celular" maxlength="10">
    <input type="password" id="pin" class="login-input" 
           placeholder="PIN" maxlength="4">
    <button onclick="ingresar()" class="login-btn">ENTRAR</button>
    <p style="margin-top: 15px; font-size: 12px; color: #666;">
        ¬øProblemas? Contacta al admin
    </p>
</div>

<!-- DASHBOARD SECTION -->
<div id="dashboardSection" style="display: none;">
    
    <!-- HEADER -->
    <div class="header">
        <h3 id="nombreMensajero">Cargando...</h3>
        <p id="fechaHoy">15 Enero 2025</p>
    </div>
    
    <!-- CONTADORES -->
    <div class="contadores">
        <div class="contador">
            <div class="numero" id="totalPaquetes">0</div>
            <div>Paquetes</div>
        </div>
        <div class="contador">
            <div class="numero" id="totalRecaudo">$0</div>
            <div>A Recaudar</div>
        </div>
    </div>
    
    <!-- PAQUETES -->
    <div id="listaPaquetes" class="lista-paquetes">
        <div class="loading">Cargando paquetes...</div>
    </div>
    
    <!-- MODAL NOVEDAD -->
    <div id="modalNovedad" class="modal">
        <div class="modal-content">
            <h3>üìù Registrar Novedad</h3>
            <p id="guiaNovedad">Gu√≠a: #000</p>
            
            <select class="select-motivo" id="selectMotivo">
                <option value="">Selecciona motivo</option>
                <option value="no_estaba">No estaba</option>
                <option value="rechazado">Rechaz√≥ el paquete</option>
                <option value="direccion_erronea">Direcci√≥n err√≥nea</option>
                <option value="otro">Otro</option>
            </select>
            
            <textarea class="textarea-obs" id="observaciones" 
                      placeholder="Observaciones..."></textarea>
            
            <div class="botones">
                <button class="btn" onclick="cerrarModal()" 
                        style="background: #6c757d; color: white;">
                    Cancelar
                </button>
                <button class="btn" onclick="confirmarNovedad()" 
                        style="background: #dc3545; color: white;">
                    Registrar
                </button>
            </div>
        </div>
    </div>
    
</div>

<script>
// VARIABLES GLOBALES
let mensajeroId = '';
let paqueteActual = null;

// AL CARGAR P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
    // Verificar sesi√≥n existente
    const sesion = localStorage.getItem('mensajero_sesion');
    if (sesion) {
        const datos = JSON.parse(sesion);
        if (Date.now() < datos.expira) {
            // Sesi√≥n v√°lida, cargar dashboard
            mensajeroId = datos.id;
            mostrarDashboard();
            cargarPaquetes();
        } else {
            // Sesi√≥n expirada
            localStorage.removeItem('mensajero_sesion');
            mostrarLogin();
        }
    } else {
        mostrarLogin();
    }
});

// FUNCI√ìN INGRESAR
function ingresar() {
    const celular = document.getElementById('celular').value.trim();
    const pin = document.getElementById('pin').value.trim();
    
    if (!celular || !pin) {
        alert('Ingresa celular y PIN');
        return;
    }
    
    // Llamar a Apps Script
    google.script.run
        .withSuccessHandler(function(respuesta) {
            if (respuesta.valido) {
                // Guardar sesi√≥n (12 horas)
                const sesion = {
                    id: respuesta.id,
                    nombre: respuesta.nombre,
                    expira: Date.now() + (12 * 60 * 60 * 1000)
                };
                localStorage.setItem('mensajero_sesion', JSON.stringify(sesion));
                
                mensajeroId = respuesta.id;
                mostrarDashboard();
                cargarPaquetes();
            } else {
                alert('Celular o PIN incorrecto');
            }
        })
        .withFailureHandler(function(error) {
            alert('Error de conexi√≥n. Reintenta.');
        })
        .validarLogin(celular, pin);
}

// MOSTRAR DASHBOARD
function mostrarDashboard() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
}

// MOSTRAR LOGIN
function mostrarLogin() {
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('dashboardSection').style.display = 'none';
}

// CARGAR PAQUETES
function cargarPaquetes() {
    if (!mensajeroId) return;
    
    google.script.run
        .withSuccessHandler(function(datos) {
            actualizarUI(datos);
        })
        .withFailureHandler(function() {
            document.getElementById('listaPaquetes').innerHTML = 
                '<div class="loading">Error al cargar. Reintenta.</div>';
        })
        .obtenerPaquetesMensajero(mensajeroId);
}

// ACTUALIZAR INTERFAZ
function actualizarUI(datos) {
    // Actualizar header
    document.getElementById('nombreMensajero').textContent = datos.nombre;
    document.getElementById('fechaHoy').textContent = datos.fecha;
    
    // Actualizar contadores
    document.getElementById('totalPaquetes').textContent = datos.totalPaquetes;
    document.getElementById('totalRecaudo').textContent = 
        '$' + datos.totalRecaudo.toLocaleString();
    
    // Actualizar lista
    let html = '';
    datos.paquetes.forEach(paquete => {
        html += `
        <div class="paquete" id="paquete-${paquete.guia}">
            <h4>#${paquete.guia} - ${paquete.destinatario}</h4>
            <p>${paquete.direccion}</p>
            <p><strong>$${paquete.valor.toLocaleString()}</strong></p>
            <div class="botones">
                <button class="btn btn-entregar" 
                        onclick="marcarEntregado('${paquete.guia}')">
                    ‚úÖ Entregado
                </button>
                <button class="btn btn-novedad" 
                        onclick="abrirModalNovedad('${paquete.guia}')">
                    üìù Novedad
                </button>
            </div>
        </div>
        `;
    });
    
    if (!html) {
        html = '<div class="loading">No hay paquetes pendientes</div>';
    }
    
    document.getElementById('listaPaquetes').innerHTML = html;
}

// MARCAR ENTREGADO
function marcarEntregado(guia) {
    google.script.run
        .withSuccessHandler(function() {
            // Remover de la lista visualmente
            document.getElementById(`paquete-${guia}`).remove();
            // Recargar contadores
            cargarPaquetes();
        })
        .registrarEntrega(mensajeroId, guia, 'entregado', null);
}

// ABRIR MODAL NOVEDAD
function abrirModalNovedad(guia) {
    paqueteActual = guia;
    document.getElementById('guiaNovedad').textContent = `Gu√≠a: #${guia}`;
    document.getElementById('modalNovedad').style.display = 'block';
}

// CERRAR MODAL
function cerrarModal() {
    paqueteActual = null;
    document.getElementById('modalNovedad').style.display = 'none';
    // Limpiar campos
    document.getElementById('selectMotivo').value = '';
    document.getElementById('observaciones').value = '';
}

// CONFIRMAR NOVEDAD
function confirmarNovedad() {
    const motivo = document.getElementById('selectMotivo').value;
    const observaciones = document.getElementById('observaciones').value;
    
    if (!motivo) {
        alert('Selecciona un motivo');
        return;
    }
    
    google.script.run
        .withSuccessHandler(function() {
            cerrarModal();
            document.getElementById(`paquete-${paqueteActual}`).remove();
            cargarPaquetes();
        })
        .registrarEntrega(mensajeroId, paqueteActual, 'novedad', 
                         `${motivo}: ${observaciones}`);
}

// SALIR
function salir() {
    localStorage.removeItem('mensajero_sesion');
    location.reload();
}
</script>

</body>
</html>