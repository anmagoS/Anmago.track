<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Anmago Track - Solución de Novedad</title>
  <style>
    /* (Mantener todos los estilos igual) */
    /* ... estilos anteriores ... */
  </style>
</head>
<body>
  <header>
    <h1>Anmago Track</h1>
  </header>

  <main>
    <h2>Solución de Novedad</h2>
    <p>Por favor diligencie la solución para la guía:</p>
    <p id="guia" style="font-weight:bold; color:#1abc9c;"></p>

    <form method="GET" action="https://script.google.com/macros/s/AKfycbxIipuPmVAvaTt7_oUQzMLNtXIah19dcq2CWkaoglQvFivqY-wBYEw64tvUmL4-1k62/exec">
      <input type="hidden" name="guia" id="guiaInput">
      <input type="hidden" name="fecha_bogota" id="fechaBogota">
      
      <label for="solucion">Solución:</label>
      <textarea id="solucion" name="solucion" rows="4" required></textarea>
      
      <button type="submit">Enviar Solución</button>
    </form>
  </main>

  <footer>
    <p>© 2026 Anmago Track</p>
    <p>Contacto: <a href="mailto:contacto@anmago.com">contacto@anmago.com</a> | Tel: +57 300 649 8710</p>
    <p>Bogotá, Colombia</p>
  </footer>

  <script>
    // Leer parámetro "guia" de la URL
    const params = new URLSearchParams(window.location.search);
    const guia = params.get("guia");
    
    if (guia) {
      document.getElementById("guia").textContent = guia;
      document.getElementById("guiaInput").value = guia;
    }
    
    // ============================================
    // SOLUCIÓN CORRECTA: OBTENER HORA BOGOTÁ DESDE EL SERVIDOR
    // ============================================
    
    // OPCIÓN 1: Usar API pública para obtener hora exacta de Bogotá
    async function obtenerHoraBogotaDesdeAPI() {
      try {
        // Usar WorldTimeAPI para Bogotá (America/Bogota)
        const response = await fetch('https://worldtimeapi.org/api/timezone/America/Bogota');
        const data = await response.json();
        
        // La API devuelve fecha en formato ISO
        const fechaBogota = new Date(data.datetime);
        return fechaBogota;
        
      } catch (error) {
        console.error('Error obteniendo hora de API:', error);
        return null;
      }
    }
    
    // OPCIÓN 2: Cálculo aproximado si la API falla (UTC-5)
    function obtenerHoraBogotaAproximada() {
      const ahora = new Date();
      // Bogotá: UTC-5 todo el año (no hay horario de verano)
      const offsetBogota = -5; // horas
      const horaBogota = new Date(ahora.getTime() + (offsetBogota * 60 * 60 * 1000));
      return horaBogota;
    }
    
    // OPCIÓN 3: Mejor aún - que el SERVIDOR (Google Apps Script) ponga la fecha
    function formatearFecha(date) {
      const dia = date.getDate().toString().padStart(2, '0');
      const mes = (date.getMonth() + 1).toString().padStart(2, '0');
      const anio = date.getFullYear();
      const horas = date.getHours().toString().padStart(2, '0');
      const minutos = date.getMinutes().toString().padStart(2, '0');
      const segundos = date.getSeconds().toString().padStart(2, '0');
      
      return `${dia}/${mes}/${anio} ${horas}:${minutos}:${segundos}`;
    }
    
    // AGREGAR FECHA AL TEXTAREA
    document.addEventListener('DOMContentLoaded', async function() {
      const textareaSolucion = document.getElementById('solucion');
      const fechaBogotaInput = document.getElementById('fechaBogota');
      
      // Primero intentar con API
      let fechaBogota = await obtenerHoraBogotaDesdeAPI();
      
      // Si falla la API, usar cálculo aproximado
      if (!fechaBogota) {
        fechaBogota = obtenerHoraBogotaAproximada();
        console.log('Usando cálculo aproximado de hora Bogotá');
      } else {
        console.log('Hora Bogotá obtenida de API mundial');
      }
      
      // Formatear fecha
      const fechaFormateada = formatearFecha(fechaBogota);
      
      // Guardar fecha en campo oculto
      fechaBogotaInput.value = fechaFormateada;
      
      // Si el textarea está vacío, agregar fecha automáticamente
      if (textareaSolucion && textareaSolucion.value.trim() === '') {
        textareaSolucion.value = `[${fechaFormateada}] `;
        textareaSolucion.focus();
        
        // Mover cursor al final
        textareaSolucion.selectionStart = textareaSolucion.value.length;
        textareaSolucion.selectionEnd = textareaSolucion.value.length;
      }
      
      console.log('Fecha Bogotá generada:', fechaFormateada);
      
      // Mostrar info en pantalla (opcional)
      document.getElementById('guia').innerHTML += 
        `<br><small>Hora actual Bogotá: ${fechaFormateada}</small>`;
    });
    
  </script>
</body>
</html>
