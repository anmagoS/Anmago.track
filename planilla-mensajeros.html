<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Mensajeros - Administrador</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%233B82F6%22/><path d=%22M30 40 L70 40 L80 60 L20 60 Z%22 fill=%22white%22/><circle cx=%2250%22 cy=%2275%22 r=%228%22 fill=%22white%22/></svg>">
    
    <style>
        /* Estilos optimizados para impresi√≥n */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                font-size: 10px !important;
                margin: 0;
                padding: 5px;
                line-height: 1.2;
            }
            
            .print-optimized {
                font-family: Arial, Helvetica, sans-serif;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9px !important;
            }
            
            th, td {
                padding: 2px 3px !important;
                border: 1px solid #000;
                height: 18px;
            }
            
            .guia-checkbox {
                width: 15px;
                height: 15px;
                border: 1px solid #000;
                margin: 0 auto;
            }
            
            .header-impresion {
                margin-bottom: 10px;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            /* Reducir m√°rgenes para aprovechar espacio */
            @page {
                margin: 0.5cm;
            }
        }
        
        /* Estilos para pantalla */
        .firma-line {
            border-top: 1px solid #000;
            margin-top: 20px;
            padding-top: 3px;
            font-size: 9px;
        }
        
        /* Estilos para estados */
        .estado-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .estado-RECIBIDO {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .estado-REPARTO {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .estado-ENTREGADO {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .estado-NOVEDAD {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .estado-CANCELADO {
            background-color: #f5f5f5;
            color: #616161;
        }
    </style>
    
    <script>
        // VERIFICACI√ìN DE AUTENTICACI√ìN Y ROL ADMIN
        (function() {
            const usuario = JSON.parse(localStorage.getItem("usuarioLogueado"));
            
            if (!usuario) {
                console.log("‚ùå No autorizado");
                window.location.replace("login.html");
                return;
            }
            
            if (usuario.ROL !== "ADMIN") {
                console.log("‚ùå No tiene permisos de administrador");
                alert("Solo usuarios ADMIN pueden acceder a esta p√°gina");
                window.location.replace("historial.html");
                return;
            }
            
            console.log("‚úÖ Admin autorizado:", usuario.USUARIO);
        })();
    </script>
</head>
<body class="bg-gray-100">
    
    <!-- Header de navegaci√≥n -->
    <nav class="bg-white shadow-md p-4 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-home"></i> Inicio
                </a>
                <a href="historial.html" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-history"></i> Historial
                </a>
            </div>
            <div class="text-right">
                <h1 class="text-xl font-bold text-gray-800">üìã Planilla de Mensajeros</h1>
                <p class="text-sm text-gray-600">Generar planilla para env√≠os en REPARTO</p>
            </div>
        </div>
    </nav>
    
    <!-- Controles de filtros -->
    <div class="container mx-auto p-4 no-print">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="text-lg font-bold mb-4">Filtros para Planilla</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                    <input type="date" id="fechaFiltro" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="mensajeFecha" class="text-xs text-gray-600 mt-1 italic"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mensajero</label>
                    <select id="mensajeroFiltro" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los mensajeros</option>
                        <!-- Se llena din√°micamente -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                    <select id="estadoFiltro" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="RECIBIDO">RECIBIDO (para planilla)</option>
                        <option value="REPARTO">EN REPARTO</option>
                        <option value="ENTREGADO">ENTREGADO</option>
                        <option value="NOVEDAD">NOVEDAD</option>
                        <option value="CANCELADO">CANCELADO</option>
                        <option value="">Todos los estados</option>
                    </select>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <button id="btnCargarHoy" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    <i class="fas fa-calendar-day mr-2"></i>Hoy
                </button>
                <button id="btnCargarEnv√≠os" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    <i class="fas fa-sync-alt mr-2"></i>Cargar Env√≠os
                </button>
                <button id="btnGenerarPlanilla" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    <i class="fas fa-print mr-2"></i>Generar Planilla
                </button>
                <button id="btnLimpiarFiltros" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    <i class="fas fa-broom mr-2"></i>Limpiar
                </button>
                <button id="btnCambiarReparto" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                    <i class="fas fa-truck-loading mr-2"></i>Cambiar a REPARTO
                </button>
            </div>
            
            <!-- Mensaje informativo -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Instrucciones:</strong> 
                    1. Carga env√≠os con estado "RECIBIDO" 
                    2. Selecciona los env√≠os para la planilla 
                    3. Genera planilla ‚Üí Los env√≠os pasan a "REPARTO"
                </p>
            </div>
        </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="container mx-auto px-4 mb-4 no-print">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-sm text-gray-600">Env√≠os RECIBIDOS</p>
                    <p class="text-2xl font-bold text-blue-600" id="totalRecibidos">0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-sm text-gray-600">Valor a Recaudar</p>
                    <p class="text-2xl font-bold text-green-600" id="totalRecaudar">$0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-sm text-gray-600">Mensajeros</p>
                    <p class="text-2xl font-bold text-indigo-600" id="totalMensajeros">0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-center">
                    <p class="text-sm text-gray-600">Seleccionados</p>
                    <p class="text-2xl font-bold text-purple-600" id="totalSeleccionados">0</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vista previa en pantalla -->
    <div class="container mx-auto px-4 no-print">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Env√≠os para planilla</h3>
                <div class="flex items-center space-x-2">
                    <div class="text-sm text-gray-600">
                        Mostrando: <span id="mostrandoCount">0</span> de <span id="totalCount">0</span>
                    </div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="selectAll" class="rounded">
                        <span class="text-sm">Seleccionar todos</span>
                    </label>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border text-sm" id="tablaPreview">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-2 border text-center w-10">
                                <input type="checkbox" id="headerCheckbox" class="rounded">
                            </th>
                            <th class="py-2 px-2 border">ID GU√çA</th>
                            <th class="py-2 px-2 border">DESTINATARIO</th>
                            <th class="py-2 px-2 border">TEL√âFONO</th>
                            <th class="py-2 px-2 border">VALOR</th>
                            <th class="py-2 px-2 border">MENSAJERO</th>
                            <th class="py-2 px-2 border">ESTADO</th>
                            <th class="py-2 px-2 border">OBSERVACIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tablaPreviewBody">
                        <tr>
                            <td colspan="8" class="py-8 text-center text-gray-500">
                                <i class="fas fa-box-open text-4xl mb-2"></i>
                                <p>No hay env√≠os para mostrar</p>
                                <p class="text-sm">Usa los filtros para cargar env√≠os</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Plantilla para impresi√≥n (oculta en pantalla) -->
    <div id="plantillaImpresion" class="hidden">
        <!-- Se genera din√°micamente -->
    </div>
    
    <script>
        // Configuraci√≥n
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIipuPmVAvaTt7_oUQzMLNtXIah19dcq2CWkaoglQvFivqY-wBYEw64tvUmL4-1k62/exec";
        
        // Variables globales
        let todosEnvios = [];
        let enviosFiltrados = [];
        let mensajerosLista = [];
        let enviosSeleccionadosIds = new Set(); // Para trackear selecciones
        
        // Estados v√°lidos del sistema
        const ESTADOS_SISTEMA = {
            RECIBIDO: "RECIBIDO",
            REPARTO: "REPARTO", 
            ENTREGADO: "ENTREGADO",
            NOVEDAD: "NOVEDAD",
            CANCELADO: "CANCELADO"
        };
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            inicializarPlanilla();
        });
        
        function inicializarPlanilla() {
            // Configurar fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaFiltro').value = hoy;
            
            // Configurar estado por defecto a RECIBIDO
            document.getElementById('estadoFiltro').value = ESTADOS_SISTEMA.RECIBIDO;
            
            // Configurar eventos
            configurarEventos();
            
            // Cargar mensajeros
            cargarMensajeros();
            
            // Cargar env√≠os del d√≠a actual (RECIBIDOS)
            cargarEnviosDelDia();
        }
        
        function configurarEventos() {
            // Botones principales
            document.getElementById('btnCargarHoy').addEventListener('click', cargarEnviosDelDia);
            document.getElementById('btnCargarEnv√≠os').addEventListener('click', cargarEnviosPorFechaDesdeAPI);
            document.getElementById('btnGenerarPlanilla').addEventListener('click', generarPlanillaImpresion);
            document.getElementById('btnLimpiarFiltros').addEventListener('click', limpiarFiltros);
            document.getElementById('btnCambiarReparto').addEventListener('click', cambiarEnv√≠osAReparto);
            
            // Filtros
            document.getElementById('fechaFiltro').addEventListener('change', aplicarFiltros);
            document.getElementById('mensajeroFiltro').addEventListener('change', aplicarFiltros);
            document.getElementById('estadoFiltro').addEventListener('change', aplicarFiltros);
            
            // Selecci√≥n multiple
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
            document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAll);
        }
        
        async function cargarMensajeros() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getMensajeros`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && Array.isArray(data.mensajeros)) {
                        mensajerosLista = data.mensajeros.sort();
                        actualizarSelectMensajeros();
                        console.log('‚úÖ Mensajeros cargados:', mensajerosLista.length);
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è No se pudieron cargar mensajeros:', error);
                // Intentar extraer de localStorage
                let historial = JSON.parse(localStorage.getItem('historialCompleto')) || [];
                if (historial.length > 0) {
                    const mensajerosSet = new Set();
                    historial.forEach(envio => {
                        const mensajero = envio["MENSAJERO"] || envio.mensajero;
                        if (mensajero && mensajero !== 'Por asignar') {
                            mensajerosSet.add(mensajero);
                        }
                    });
                    mensajerosLista = Array.from(mensajerosSet).sort();
                    actualizarSelectMensajeros();
                }
            }
        }
        
        async function cargarEnviosDelDia() {
            const ahora = new Date();
            const horaActual = ahora.getHours();
            
            // Determinar qu√© fecha mostrar
            let fechaParaCargar;
            
            if (horaActual < 12) {
                // Si es antes del mediod√≠a, cargar env√≠os de ayer
                const ayer = new Date();
                ayer.setDate(ayer.getDate() - 1);
                fechaParaCargar = ayer.toISOString().split('T')[0];
                console.log('üïê Es temprano, cargando env√≠os de ayer:', fechaParaCargar);
            } else {
                // Si es despu√©s del mediod√≠a, cargar env√≠os de hoy
                fechaParaCargar = ahora.toISOString().split('T')[0];
                console.log('üïê Es tarde, cargando env√≠os de hoy:', fechaParaCargar);
            }
            
            document.getElementById('fechaFiltro').value = fechaParaCargar;
            actualizarMensajeFecha(horaActual);
            
            await cargarEnviosPorFechaDesdeAPI();
        }
        
        function actualizarMensajeFecha(horaActual) {
            const mensajeDiv = document.getElementById('mensajeFecha');
            if (mensajeDiv) {
                mensajeDiv.innerHTML = horaActual < 12 
                    ? 'Mostrando env√≠os RECIBIDOS del d√≠a anterior'
                    : 'Mostrando env√≠os RECIBIDOS del d√≠a actual';
            }
        }
        
        async function cargarEnviosPorFechaDesdeAPI() {
            try {
                mostrarLoading(true);
                
                const fecha = document.getElementById('fechaFiltro').value;
                console.log('üìÖ Cargando env√≠os para fecha:', fecha);
                
                const url = `${WEB_APP_URL}?action=getAllEnvios&fecha=${encodeURIComponent(fecha)}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && Array.isArray(data.data)) {
                        todosEnvios = data.data;
                        console.log(`‚úÖ ${todosEnvios.length} env√≠os cargados para ${fecha}`);
                        
                        // Mostrar informaci√≥n del primer env√≠o para debug
                        if (todosEnvios.length > 0) {
                            const primerEnvio = todosEnvios[0];
                            console.log('üîç Ejemplo de env√≠o cargado:', {
                                id: primerEnvio["ENVIO ID"],
                                fecha: primerEnvio["FECHA DE CREACION"],
                                estado: primerEnvio["ESTADO"],
                                destinatario: primerEnvio["DESTINO"],
                                mensajero: primerEnvio["MENSAJERO"]
                            });
                            
                            // Mostrar distribuci√≥n de estados
                            const estadosCount = {};
                            todosEnvios.forEach(envio => {
                                const estado = envio["ESTADO"] || ESTADOS_SISTEMA.RECIBIDO;
                                estadosCount[estado] = (estadosCount[estado] || 0) + 1;
                            });
                            console.log('üìä Distribuci√≥n de estados:', estadosCount);
                        }
                    } else {
                        console.log('‚ö†Ô∏è Respuesta API no exitosa:', data);
                        todosEnvios = [];
                    }
                } else {
                    console.error('‚ùå Error en respuesta HTTP:', response.status);
                    todosEnvios = [];
                }
                
                if (todosEnvios.length === 0) {
                    console.log('‚ö†Ô∏è No hay env√≠os para la fecha seleccionada');
                    mostrarError('No se encontraron env√≠os para la fecha seleccionada');
                    
                    // Intentar desde localStorage
                    let historial = JSON.parse(localStorage.getItem('historialCompleto')) || [];
                    if (historial.length > 0) {
                        todosEnvios = filtrarEnviosPorFechaLocal(historial, fecha);
                        console.log(`üîÑ ${todosEnvios.length} env√≠os cargados desde localStorage`);
                    }
                }
                
                // Extraer mensajeros de los env√≠os
                extraerMensajerosDeEnvios();
                
                // Aplicar filtros (por defecto muestra RECIBIDOS)
                aplicarFiltros();
                
            } catch (error) {
                console.error('‚ùå Error cargando env√≠os:', error);
                mostrarError('Error al cargar env√≠os: ' + error.message);
                
                // Intentar desde localStorage
                try {
                    let historial = JSON.parse(localStorage.getItem('historialCompleto')) || [];
                    const fecha = document.getElementById('fechaFiltro').value;
                    todosEnvios = filtrarEnviosPorFechaLocal(historial, fecha);
                    console.log(`üîÑ ${todosEnvios.length} env√≠os cargados desde localStorage despu√©s de error`);
                    
                    extraerMensajerosDeEnvios();
                    aplicarFiltros();
                } catch (localError) {
                    console.error('‚ùå Error tambi√©n en localStorage:', localError);
                }
            } finally {
                mostrarLoading(false);
            }
        }
        
        function filtrarEnviosPorFechaLocal(envios, fecha) {
            const fechaFormateada = new Date(fecha).toISOString().split('T')[0];
            
            return envios.filter(envio => {
                try {
                    const fechaEnvio = envio["FECHA DE CREACION"] || envio.fechaCreacion || envio.fecha;
                    if (!fechaEnvio) return false;
                    
                    const fechaObj = new Date(fechaEnvio);
                    if (isNaN(fechaObj.getTime())) return false;
                    
                    const fechaEnvioStr = fechaObj.toISOString().split('T')[0];
                    return fechaEnvioStr === fechaFormateada;
                } catch (e) {
                    return false;
                }
            });
        }
        
        function extraerMensajerosDeEnvios() {
            if (todosEnvios.length > 0) {
                const mensajerosSet = new Set();
                todosEnvios.forEach(envio => {
                    const mensajero = envio["MENSAJERO"] || envio.mensajero;
                    if (mensajero && mensajero.trim() !== '' && mensajero !== 'Por asignar') {
                        mensajerosSet.add(mensajero.trim());
                    }
                });
                
                const nuevosMensajeros = Array.from(mensajerosSet).sort();
                if (nuevosMensajeros.length > 0) {
                    const todosMensajeros = [...new Set([...mensajerosLista, ...nuevosMensajeros])].sort();
                    if (todosMensajeros.length !== mensajerosLista.length) {
                        mensajerosLista = todosMensajeros;
                        actualizarSelectMensajeros();
                    }
                }
            }
        }
        
        function aplicarFiltros() {
            const mensajero = document.getElementById('mensajeroFiltro').value;
            const estadoFiltro = document.getElementById('estadoFiltro').value;
            
            // Filtrar env√≠os
            enviosFiltrados = todosEnvios.filter(envio => {
                let cumple = true;
                
                // Filtrar por mensajero
                if (mensajero && mensajero !== '') {
                    const mensajeroEnvio = (envio["MENSAJERO"] || envio.mensajero || '').toUpperCase();
                    cumple = cumple && (mensajeroEnvio === mensajero.toUpperCase());
                }
                
                // Filtrar por estado (si se especific√≥)
                if (estadoFiltro && estadoFiltro !== '') {
                    const estadoEnvio = (envio["ESTADO"] || ESTADOS_SISTEMA.RECIBIDO).toUpperCase();
                    cumple = cumple && (estadoEnvio === estadoFiltro.toUpperCase());
                }
                
                return cumple;
            });
            
            // Actualizar contadores
            document.getElementById('mostrandoCount').textContent = enviosFiltrados.length;
            document.getElementById('totalCount').textContent = todosEnvios.length;
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas();
            
            // Actualizar vista previa
            actualizarVistaPrevia();
            
            console.log(`‚úÖ ${enviosFiltrados.length} env√≠os despu√©s de filtrar (estado: ${estadoFiltro || 'todos'})`);
        }
        
        function actualizarEstadisticas() {
            // Contar env√≠os RECIBIDOS
            const recibidos = todosEnvios.filter(envio => {
                const estado = (envio["ESTADO"] || ESTADOS_SISTEMA.RECIBIDO).toUpperCase();
                return estado === ESTADOS_SISTEMA.RECIBIDO;
            });
            document.getElementById('totalRecibidos').textContent = recibidos.length;
            
            // Calcular valor a recaudar de los filtrados
            let totalRecaudar = 0;
            enviosFiltrados.forEach(envio => {
                const valor = parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0);
                if (!isNaN(valor)) totalRecaudar += valor;
            });
            document.getElementById('totalRecaudar').textContent = `$${totalRecaudar.toLocaleString('es-CO')}`;
            
            // Contar mensajeros √∫nicos en filtrados
            const mensajerosUnicos = new Set();
            enviosFiltrados.forEach(envio => {
                const mensajero = envio["MENSAJERO"] || envio.mensajero;
                if (mensajero && mensajero !== 'Por asignar') {
                    mensajerosUnicos.add(mensajero);
                }
            });
            document.getElementById('totalMensajeros').textContent = mensajerosUnicos.size;
            
            // Contar seleccionados
            document.getElementById('totalSeleccionados').textContent = enviosSeleccionadosIds.size;
        }
        
        function actualizarVistaPrevia() {
            const tbody = document.getElementById('tablaPreviewBody');
            
            if (enviosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-2"></i>
                            <p>No hay env√≠os para mostrar</p>
                            <p class="text-sm">Usa los filtros para cargar env√≠os</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            enviosFiltrados.forEach((envio, index) => {
                const envioId = envio["ENVIO ID"] || envio.id || `N/A-${index}`;
                const estaSeleccionado = enviosSeleccionadosIds.has(envioId);
                const valor = parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0);
                const telefono = envio["TELEFONOCLIENTE"] || envio.telefonoCliente || '';
                const destinatario = envio["DESTINO"] || envio.destino || 'N/A';
                const mensajero = envio["MENSAJERO"] || envio.mensajero || 'Por asignar';
                const estado = envio["ESTADO"] || ESTADOS_SISTEMA.RECIBIDO;
                const observacion = envio["OBS"] || envio.observaciones || '';
                
                // Determinar clase CSS para el estado
                const estadoClass = `estado-${estado}`;
                
                html += `
                    <tr class="hover:bg-gray-50 ${estaSeleccionado ? 'bg-blue-50' : ''}">
                        <td class="py-2 px-2 border text-center">
                            <input type="checkbox" 
                                   class="envio-checkbox" 
                                   data-id="${envioId}"
                                   ${estaSeleccionado ? 'checked' : ''}>
                        </td>
                        <td class="py-2 px-2 border font-mono text-xs">
                            ${envioId}
                        </td>
                        <td class="py-2 px-2 border">
                            ${destinatario}
                        </td>
                        <td class="py-2 px-2 border font-mono">
                            ${telefono}
                        </td>
                        <td class="py-2 px-2 border font-bold text-right">
                            $${valor.toLocaleString('es-CO')}
                        </td>
                        <td class="py-2 px-2 border">
                            ${mensajero}
                        </td>
                        <td class="py-2 px-2 border text-center">
                            <span class="estado-badge ${estadoClass}">${estado}</span>
                        </td>
                        <td class="py-2 px-2 border">
                            <input type="text" 
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs" 
                                   placeholder="Observaciones" 
                                   value="${observacion}"
                                   data-id="${envioId}"
                                   onchange="actualizarObservacion('${envioId}', this.value)">
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // A√±adir eventos a los checkboxes
            document.querySelectorAll('.envio-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const envioId = this.dataset.id;
                    if (this.checked) {
                        enviosSeleccionadosIds.add(envioId);
                    } else {
                        enviosSeleccionadosIds.delete(envioId);
                    }
                    
                    // Actualizar contador
                    document.getElementById('totalSeleccionados').textContent = enviosSeleccionadosIds.size;
                    
                    // Actualizar fila con estilo
                    const fila = this.closest('tr');
                    if (this.checked) {
                        fila.classList.add('bg-blue-50');
                    } else {
                        fila.classList.remove('bg-blue-50');
                    }
                    
                    console.log('Selecci√≥n actualizada:', enviosSeleccionadosIds.size, 'seleccionados');
                });
            });
            
            // Actualizar checkboxes header
            const totalCheckboxes = document.querySelectorAll('.envio-checkbox').length;
            const checkedCheckboxes = document.querySelectorAll('.envio-checkbox:checked').length;
            document.getElementById('headerCheckbox').checked = totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes;
            document.getElementById('selectAll').checked = totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes;
        }
        
        function toggleSelectAll(event) {
            const isChecked = event.target.checked;
            const checkboxes = document.querySelectorAll('.envio-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const envioId = checkbox.dataset.id;
                
                if (isChecked) {
                    enviosSeleccionadosIds.add(envioId);
                    const fila = checkbox.closest('tr');
                    fila.classList.add('bg-blue-50');
                } else {
                    enviosSeleccionadosIds.delete(envioId);
                    const fila = checkbox.closest('tr');
                    fila.classList.remove('bg-blue-50');
                }
            });
            
            document.getElementById('headerCheckbox').checked = isChecked;
            document.getElementById('selectAll').checked = isChecked;
            document.getElementById('totalSeleccionados').textContent = enviosSeleccionadosIds.size;
            
            console.log('Todos seleccionados:', isChecked, '| Total:', enviosSeleccionadosIds.size);
        }
        
        function actualizarObservacion(envioId, observacion) {
            console.log('Observaci√≥n actualizada para', envioId, ':', observacion);
            // Aqu√≠ podr√≠as guardar la observaci√≥n si necesitas persistencia
        }
        
        async function cambiarEnv√≠osAReparto() {
            if (enviosSeleccionadosIds.size === 0) {
                alert('Selecciona al menos un env√≠o para cambiar a estado REPARTO');
                return;
            }
            
            const enviosIds = Array.from(enviosSeleccionadosIds);
            
            if (!confirm(`¬øCambiar ${enviosIds.length} env√≠o(s) a estado REPARTO?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                mostrarLoading(true);
                
                // Usar la API para cambiar estado
                const url = `${WEB_APP_URL}?action=cambiarMasivoReparto&ids=${encodeURIComponent(JSON.stringify(enviosIds))}`;
                console.log('URL para cambiar estado:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.actualizados} env√≠os cambiados a REPARTO exitosamente`);
                    
                    // Actualizar la lista local
                    todosEnvios.forEach(envio => {
                        const envioId = envio["ENVIO ID"] || envio.id;
                        if (enviosIds.includes(envioId)) {
                            envio["ESTADO"] = ESTADOS_SISTEMA.REPARTO;
                        }
                    });
                    
                    // Limpiar selecciones
                    enviosSeleccionadosIds.clear();
                    
                    // Volver a aplicar filtros
                    aplicarFiltros();
                    
                    // Recargar datos para asegurar sincronizaci√≥n
                    setTimeout(() => cargarEnviosPorFechaDesdeAPI(), 1000);
                    
                } else {
                    alert('‚ùå Error al cambiar estados: ' + (data.error || 'Desconocido'));
                }
                
            } catch (error) {
                console.error('Error cambiando estados:', error);
                alert('‚ùå Error de conexi√≥n al cambiar estados');
            } finally {
                mostrarLoading(false);
            }
        }
        
        function generarPlanillaImpresion() {
            if (enviosFiltrados.length === 0) {
                alert('No hay env√≠os para generar planilla');
                return;
            }
            
            // Usar env√≠os seleccionados, o todos los filtrados si no hay selecci√≥n
            const idsParaPlanilla = enviosSeleccionadosIds.size > 0 
                ? Array.from(enviosSeleccionadosIds) 
                : enviosFiltrados.map(envio => envio["ENVIO ID"] || envio.id);
            
            const enviosParaPlanilla = enviosFiltrados.filter(envio => 
                idsParaPlanilla.includes(envio["ENVIO ID"] || envio.id)
            );
            
            if (enviosParaPlanilla.length === 0) {
                alert('No hay env√≠os seleccionados para la planilla');
                return;
            }
            
            // Verificar que los env√≠os est√©n en estado RECIBIDO
            const enviosNoRecibidos = enviosParaPlanilla.filter(envio => {
                const estado = (envio["ESTADO"] || ESTADOS_SISTEMA.RECIBIDO).toUpperCase();
                return estado !== ESTADOS_SISTEMA.RECIBIDO;
            });
            
            if (enviosNoRecibidos.length > 0) {
                const confirmar = confirm(
                    `${enviosNoRecibidos.length} env√≠o(s) no est√°n en estado RECIBIDO.\n` +
                    `Estados encontrados: ${[...new Set(enviosNoRecibidos.map(e => e["ESTADO"] || 'N/A'))].join(', ')}\n\n` +
                    `¬øDeseas generar la planilla de todas formas?`
                );
                
                if (!confirmar) {
                    return;
                }
            }
            
            // Agrupar por mensajero
            const enviosPorMensajero = {};
            enviosParaPlanilla.forEach(envio => {
                const mensajero = envio["MENSAJERO"] || envio.mensajero || 'Sin asignar';
                if (!enviosPorMensajero[mensajero]) {
                    enviosPorMensajero[mensajero] = [];
                }
                enviosPorMensajero[mensajero].push(envio);
            });
            
            // Obtener fecha para planilla
            const fechaSeleccionada = document.getElementById('fechaFiltro').value;
            const fechaParaPlanilla = new Date(fechaSeleccionada);
            const ahora = new Date();
            const horaActual = ahora.getHours();
            const hoyISO = new Date().toISOString().split('T')[0];
            const fechaSeleccionadaISO = new Date(fechaSeleccionada).toISOString().split('T')[0];
            
            let fechaFinalParaPlanilla = fechaParaPlanilla;
            
            // Ajustar fecha si es temprano
            if (fechaSeleccionadaISO === hoyISO && horaActual < 12) {
                fechaFinalParaPlanilla.setDate(fechaFinalParaPlanilla.getDate() - 1);
            }
            
            // Formatear fecha
            const fechaFormateada = fechaFinalParaPlanilla.toLocaleDateString('es-CO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const fechaGeneracion = new Date().toLocaleString('es-CO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            console.log('üìã Generando planilla para:', fechaFormateada, 
                       '| Env√≠os:', enviosParaPlanilla.length,
                       '| Mensajeros:', Object.keys(enviosPorMensajero).length);
            
            // Generar HTML de impresi√≥n
            let htmlPlanilla = '';
            
            Object.keys(enviosPorMensajero).forEach((mensajero, mensajeroIndex) => {
                const enviosMensajero = enviosPorMensajero[mensajero];
                let totalRecaudar = 0;
                
                // Calcular total
                enviosMensajero.forEach(envio => {
                    const valor = parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0);
                    if (!isNaN(valor)) totalRecaudar += valor;
                });
                
                htmlPlanilla += `
                    <div class="planilla-mensajero print-optimized" ${mensajeroIndex > 0 ? 'style="page-break-before: always;"' : ''}>
                        <div class="header-impresion text-center mb-3">
                            <h1 style="font-size: 16px; font-weight: bold; margin: 0;">EXPRES CONTRAENTREGA</h1>
                            <h2 style="font-size: 14px; font-weight: bold; margin: 0;">PLANILLA DE MENSAJERO</h2>
                            <div style="font-size: 11px; margin-top: 5px;">
                                <strong>Fecha de entrega:</strong> ${fechaFormateada} | 
                                <strong>Mensajero:</strong> ${mensajero} | 
                                <strong>Env√≠os:</strong> ${enviosMensajero.length} | 
                                <strong>Total a recaudar:</strong> $${totalRecaudar.toLocaleString('es-CO')}
                            </div>
                            <div style="font-size: 9px; color: #666; margin-top: 2px;">
                                <strong>Planilla generada:</strong> ${fechaGeneracion} | 
                                <strong>Estado anterior:</strong> RECIBIDO | 
                                <strong>Nuevo estado:</strong> REPARTO
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                            <thead>
                                <tr style="background-color: #f0f0f0;">
                                    <th style="border: 1px solid #000; padding: 2px; width: 20px;">‚úì</th>
                                    <th style="border: 1px solid #000; padding: 2px; width: 80px;">ID GU√çA</th>
                                    <th style="border: 1px solid #000; padding: 2px;">DESTINATARIO</th>
                                    <th style="border: 1px solid #000; padding: 2px; width: 70px;">TEL√âFONO</th>
                                    <th style="border: 1px solid #000; padding: 2px; width: 60px;">VALOR</th>
                                    <th style="border: 1px solid #000; padding: 2px;">OBSERVACIONES</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                enviosMensajero.forEach(envio => {
                    const valor = parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0);
                    const telefono = envio["TELEFONOCLIENTE"] || envio.telefonoCliente || '';
                    const observacion = envio["OBS"] || envio.observaciones || '';
                    
                    htmlPlanilla += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 2px; text-align: center;">
                                <div class="guia-checkbox"></div>
                            </td>
                            <td style="border: 1px solid #000; padding: 2px; font-family: monospace; font-size: 8px;">
                                ${envio["ENVIO ID"] || envio.id || ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 2px;">
                                ${envio["DESTINO"] || envio.destino || ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 2px; font-family: monospace; font-size: 8px;">
                                ${telefono}
                            </td>
                            <td style="border: 1px solid #000; padding: 2px; text-align: right; font-weight: bold;">
                                $${valor.toLocaleString('es-CO')}
                            </td>
                            <td style="border: 1px solid #000; padding: 2px; font-size: 8px;">
                                ${observacion}
                            </td>
                        </tr>
                    `;
                });
                
                htmlPlanilla += `
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 15px; font-size: 9px; border-top: 1px solid #000; padding-top: 5px;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 60%;">
                                        <strong>RESUMEN:</strong> ${enviosMensajero.length} env√≠os | Total a recaudar: $${totalRecaudar.toLocaleString('es-CO')}
                                    </td>
                                    <td style="width: 40%; text-align: center;">
                                        <div style="border-top: 1px solid #000; padding-top: 3px; margin-top: 10px;">
                                            <strong>FIRMA MENSAJERO</strong><br>
                                            Nombre: _________________________
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding-top: 10px; font-size: 8px; color: #666;">
                                        <strong>INSTRUCCIONES:</strong> Entregar seg√∫n planilla | Reportar novedades inmediatamente
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            // Mostrar confirmaci√≥n antes de imprimir
            const mensajeConfirmacion = `¬øGenerar planilla para ${enviosParaPlanilla.length} env√≠o(s)?\n\n` +
                                       `Mensajeros: ${Object.keys(enviosPorMensajero).length}\n` +
                                       `Fecha planilla: ${fechaFormateada}`;
            
            if (confirm(mensajeConfirmacion)) {
                // Insertar en contenedor de impresi√≥n
                const contenedorImpresion = document.getElementById('plantillaImpresion');
                contenedorImpresion.innerHTML = htmlPlanilla;
                contenedorImpresion.classList.remove('hidden');
                
                // Mostrar di√°logo para cambiar a REPARTO despu√©s de imprimir
                setTimeout(() => {
                    window.print();
                    
                    // Despu√©s de imprimir, preguntar si cambiar a REPARTO
                    setTimeout(() => {
                        contenedorImpresion.classList.add('hidden');
                        
                        if (confirm('¬øDeseas cambiar los env√≠os de esta planilla a estado REPARTO?\n\n' +
                                   'Los mensajeros podr√°n verlos en su app despu√©s de este cambio.')) {
                            // Cambiar autom√°ticamente a REPARTO
                            const idsParaCambio = enviosParaPlanilla
                                .filter(envio => {
                                    const estado = (envio["ESTADO"] || ESTADOS_SISTEMA.RECIBIDO).toUpperCase();
                                    return estado === ESTADOS_SISTEMA.RECIBIDO;
                                })
                                .map(envio => envio["ENVIO ID"] || envio.id);
                            
                            if (idsParaCambio.length > 0) {
                                cambiarEnviosARepartoBatch(idsParaCambio);
                            } else {
                                alert('Todos los env√≠os ya est√°n en REPARTO o otro estado');
                            }
                        }
                    }, 500);
                    
                }, 100);
            }
        }
        
        async function cambiarEnviosARepartoBatch(ids) {
            try {
                const url = `${WEB_APP_URL}?action=cambiarMasivoReparto&ids=${encodeURIComponent(JSON.stringify(ids))}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.actualizados} env√≠os cambiados a REPARTO`);
                    
                    // Actualizar datos locales
                    setTimeout(() => cargarEnviosPorFechaDesdeAPI(), 1000);
                } else {
                    alert('‚ö†Ô∏è No se pudieron cambiar todos los estados: ' + (data.error || ''));
                }
            } catch (error) {
                alert('‚ùå Error cambiando estados: ' + error.message);
            }
        }
        
        function limpiarFiltros() {
            document.getElementById('mensajeroFiltro').value = '';
            document.getElementById('estadoFiltro').value = ESTADOS_SISTEMA.RECIBIDO;
            enviosSeleccionadosIds.clear();
            aplicarFiltros();
        }
        
        function mostrarLoading(mostrar) {
            const tbody = document.getElementById('tablaPreviewBody');
            if (mostrar) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-500">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                            <p>Cargando env√≠os...</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function mostrarError(mensaje) {
            document.getElementById('tablaPreviewBody').innerHTML = `
                <tr>
                    <td colspan="8" class="py-8 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p>${mensaje}</p>
                    </td>
                </tr>
            `;
        }
        
        function actualizarSelectMensajeros() {
            const select = document.getElementById('mensajeroFiltro');
            const valorActual = select.value;
            
            select.innerHTML = '<option value="">Todos los mensajeros</option>';
            
            mensajerosLista.forEach(mensajero => {
                const option = document.createElement('option');
                option.value = mensajero;
                option.textContent = mensajero;
                select.appendChild(option);
            });
            
            if (valorActual && mensajerosLista.includes(valorActual)) {
                select.value = valorActual;
            }
        }
    </script>
</body>
</html>
